# 图片优化问题解决方案

## 问题描述

在 GitHub Actions 等 CI 环境中构建时，`getImage` 函数需要访问外部图片 URL 来获取图片尺寸，但 CI 环境可能无法访问这些外部资源，导致构建失败。

## 解决方案

我们实现了多层次的解决方案：

### 1. 自动检测 CI 环境

代码会自动检测是否在 CI 环境中运行（通过 `CI`、`GITHUB_ACTIONS` 等环境变量）。如果在 CI 环境，会自动跳过图片优化，使用默认尺寸或缓存。

### 2. 图片尺寸缓存

我们创建了图片尺寸缓存机制：

- **缓存文件**: `public/photography-cache.json`
- **缓存有效期**: 7 天
- **自动使用**: 构建时会优先从缓存读取图片尺寸

### 3. 生成缓存（推荐）

在本地开发时，运行以下命令生成图片尺寸缓存：

```bash
pnpm generate-image-cache
```

这个命令会：
1. 读取 `public/photography.txt` 中的所有图片 URL
2. 逐个获取图片尺寸
3. 保存到 `public/photography-cache.json`

**建议**: 在提交代码前运行此命令，将缓存文件一并提交，这样 CI 构建时就可以直接使用缓存，无需访问外部图片。

### 4. 自动降级处理

如果无法获取图片尺寸（网络问题、超时等），系统会自动：
- 使用默认尺寸（800x600）
- 将默认尺寸保存到缓存，避免下次重试
- 继续构建，不会中断流程

### 5. 条件渲染

在 CI 环境中，使用普通的 `<img>` 标签而不是 Astro 的 `<Image>` 组件，避免优化处理。

## 工作流程

### 本地开发
1. 首次访问摄影页面时，会尝试获取图片尺寸
2. 成功获取后，尺寸信息会保存到缓存
3. 下次构建时，直接从缓存读取

### CI 构建
1. 检测到 CI 环境，跳过图片优化
2. 优先从缓存文件读取尺寸（如果存在）
3. 如果缓存不存在，使用默认尺寸（800x600）
4. 使用普通 `<img>` 标签渲染

## 手动更新缓存

如果图片 URL 发生变化，需要更新缓存：

```bash
# 删除旧缓存
rm public/photography-cache.json

# 重新生成缓存
pnpm generate-image-cache
```

## 故障排除

### 问题：CI 构建仍然失败

**解决方案**:
1. 确保 `public/photography-cache.json` 已提交到 Git
2. 检查缓存文件格式是否正确（JSON）
3. 如果缓存文件损坏，删除后重新生成

### 问题：本地开发时图片尺寸获取失败

**解决方案**:
1. 检查网络连接
2. 检查图片 URL 是否可访问
3. 运行 `pnpm generate-image-cache` 手动生成缓存
4. 如果某些图片无法访问，脚本会自动使用默认尺寸

### 问题：缓存文件太大

**解决方案**:
- 缓存文件只包含 URL 和尺寸信息，通常很小
- 如果确实很大，可以定期清理过期条目（超过 7 天的）

## 技术细节

### 环境检测

代码会检测以下环境变量来判断是否在 CI 环境：
- `CI`
- `GITHUB_ACTIONS`
- `GITLAB_CI`
- `CIRCLECI`

### 超时设置

在本地开发时，每个图片的获取有 10 秒超时限制，避免长时间等待。

### 缓存格式

```json
{
  "images": {
    "https://example.com/image.jpg": {
      "url": "https://example.com/image.jpg",
      "width": 1920,
      "height": 1080,
      "timestamp": 1234567890000
    }
  }
}
```

## 最佳实践

1. **定期更新缓存**: 当添加新图片时，运行 `pnpm generate-image-cache` 更新缓存
2. **提交缓存文件**: 将 `public/photography-cache.json` 提交到 Git，方便 CI 使用
3. **监控构建日志**: 如果看到大量 "Skipping image optimization" 日志，说明缓存工作正常
4. **本地测试**: 在本地运行 `pnpm build` 确保一切正常
