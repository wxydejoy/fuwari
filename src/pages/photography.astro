---

import fs from "node:fs/promises";
import path from "node:path";
import { Image, getImage } from "astro:assets";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import 'photoswipe/dist/photoswipe.css';

// Read the photography.txt file during build time
let imageUrls: string[] = [];

try {
	const filePath = path.join(process.cwd(), "public", "photography.txt");
	const content = await fs.readFile(filePath, "utf-8");

	// Parse the file, each line is an image URL
	imageUrls = content
		.split("\n")
		.map((line) => line.trim())
		.filter((line) => line.length > 0 && line.startsWith("http"));
} catch (error) {
	console.error("Error reading photography.txt:", error);
}

const imageData = await Promise.all(
	imageUrls.map(async (url) => {
		try {
			const optimized = await getImage({ src: url, inferSize: true });
			return {
				url,
				width: optimized.attributes.width as number,
				height: optimized.attributes.height as number,
			};
		} catch (e) {
			console.error(`Failed to get size for ${url}`, e);
			return { url, width: 800, height: 600 }; // Fallback
		}
	}),
);
---
<MainGridLayout title="摄影" description="我的摄影作品集，记录生活中的点滴时刻。">
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
        <div class="card-base z-10 px-9 py-6 relative w-full ">
            <h1 class="text-2xl font-bold mb-6">我的摄影作品</h1>
            
            {imageData.length > 0 ? (
                <div id="photography-gallery" class="grid grid-cols-1 md:grid-cols-2 gap-4" style="grid-auto-rows: 10px;">
                    {imageData.map((img, index) => (
                        <div 
                            class="photography-card relative overflow-hidden bg-gray-200 dark:bg-gray-800 shadow-sm hover:shadow-md transition-all duration-300 opacity-0 animate-fadeIn"
                            style={`animation-delay: ${index * 100}ms; grid-row: span ${Math.max(10, Math.ceil((img.height / img.width) * 20))};`}
                        >
                            <div class="skeleton-loader absolute inset-0 bg-gradient-to-r from-gray-200 via-gray-100 to-gray-200 dark:from-gray-800 dark:via-gray-700 dark:to-gray-800 bg-[length:200%_100%] animate-shimmer"></div>
                            <a 
                                href={img.url} 
                                class="block w-full h-full cursor-zoom-in photography-link"
                                data-pswp-width={img.width}
                                data-pswp-height={img.height}
                                target="_blank"
                            >
                                <Image 
                                    src={img.url} 
                                    width={img.width}
                                    height={img.height}
                                    alt={`摄影作品 ${index + 1}`} 
                                    class="w-full h-full object-cover transition-all duration-500 hover:scale-110 photography-image"
                                    loading="lazy"
                                    decoding="async"
                                />
                            </a>
                        </div>
                    ))}
                </div>
            ) : (
                <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                    <p>暂无摄影作品</p>
                    <p class="text-sm mt-2">请在 public/photography.txt 文件中添加图片链接</p>
                </div>
            )}
        </div>
    </div>
</MainGridLayout>

<style>
    /* Custom animations */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
    
    .animate-fadeIn {
        animation: fadeIn 0.5s ease-out forwards;
    }
    
    .animate-shimmer {
        animation: shimmer 2s infinite linear;
    }

    .photography-image {
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }

    .photography-image.loaded {
        opacity: 1;
    }
</style>

<script>
    function initImages() {
        const images = document.querySelectorAll('.photography-image');
        images.forEach(img => {
            if ((img as HTMLImageElement).complete) {
                img.classList.add('loaded');
                img.closest('.photography-card')?.querySelector('.skeleton-loader')?.remove();
            } else {
                img.addEventListener('load', () => {
                    img.classList.add('loaded');
                    img.closest('.photography-card')?.querySelector('.skeleton-loader')?.remove();
                });
            }
        });
    }

    // Initialize on first load
    initImages();

    // Re-initialize after Swup content replace
    document.addEventListener('swup:content:replace', initImages);
</script>