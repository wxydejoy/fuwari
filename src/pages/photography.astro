---
import fs from "node:fs/promises";
import path from "node:path";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import { filterValidUrls } from "../utils/url-validator";
import 'photoswipe/dist/photoswipe.css';

// Read the photography.txt file during build time
// 完全客户端渲染，不依赖构建时获取图片尺寸
let imageUrls: string[] = [];

try {
	const filePath = path.join(process.cwd(), "public", "photography.txt");
	const content = await fs.readFile(filePath, "utf-8");

	// Parse the file, each line is an image URL
	const rawUrls = content
		.split("\n")
		.map((line) => line.trim())
		.filter((line) => line.length > 0 && line.startsWith("http"));
	
	// 验证和过滤 URL
	imageUrls = filterValidUrls(rawUrls);
} catch (error) {
	// 使用 logger 如果可用，否则使用 console
	if (typeof console !== "undefined") {
		console.error("Error reading photography.txt:", error);
	}
	imageUrls = [];
}
---
<MainGridLayout title="摄影" description="我的摄影作品集，记录生活中的点滴时刻。">
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
        <div class="card-base z-10 px-9 py-6 relative w-full ">
            <h1 class="text-2xl font-bold mb-6">我的摄影作品</h1>
            
            <div class="mb-8 p-6 bg-gray-100 dark:bg-gray-800 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">我的装备</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium mb-2">索尼 ZV-E10</h3>
                        <p class="mb-1"><strong>型号：</strong>ZV-E10</p>
                        <p class="mb-1"><strong>类型：</strong>APS-C 画幅微单相机</p>
                        <p class="mb-1"><strong>传感器：</strong>2420 万像素 APS-C CMOS</p>
                        <p class="mb-1"><strong>视频：</strong>4K 30fps / 1080p 120fps</p>
                        <p class="mb-1"><strong>特点：</strong>翻转触摸屏、侧开式 HDMI、优秀的自动对焦</p>
                        <p><strong>用途：</strong>日常拍摄、vlog、风景摄影</p>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium mb-2">镜头</h3>
                        <ul class="list-disc list-inside ml-2">
                            <li>适马 18-50mm f/2.8 DC DN Contemporary</li>
                            <li>索尼 16-50mm f/3.5-5.6 OSS</li>
                            <li>索尼 55-210mm f/4.5-6.3 OSS</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            {imageUrls.length > 0 ? (
                <div id="photography-gallery" class="columns-1 md:columns-2 gap-4">
                    {imageUrls.map((url, index) => (
                        <div 
                            class="photography-card break-inside-avoid mb-4 relative overflow-hidden bg-gray-200 dark:bg-gray-800 shadow-sm rounded-lg"
                            data-image-url={url}
                            data-image-index={index}
                        >
                            <a 
                                href={url} 
                                class="block w-full h-full cursor-zoom-in photography-link"
                                target="_blank"
                                rel="noopener noreferrer"
                            >
                                <img 
                                    src={url} 
                                    alt={`摄影作品 ${index + 1}`} 
                                    class="w-full h-auto photography-image"
                                    loading="lazy"
                                    decoding="async"
                                />
                            </a>
                        </div>
                    ))}
                </div>
            ) : (
                <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                    <p>暂无摄影作品</p>
                    <p class="text-sm mt-2">请在 public/photography.txt 文件中添加图片链接</p>
                </div>
            )}
        </div>
    </div>
</MainGridLayout>

<style>
    .photography-image {
        opacity: 1;
    }
    
    .photography-card {
        display: block;
        width: 100%;
    }
    
    /* 确保图片容器正确显示 */
    #photography-gallery {
        display: block;
    }
</style>

<script>
    // 客户端动态设置图片尺寸和 PhotoSwipe 数据
    document.addEventListener('DOMContentLoaded', () => {
        const gallery = document.getElementById('photography-gallery');
        if (!gallery) return;

        const cards = gallery.querySelectorAll('.photography-card');
        
        cards.forEach((card) => {
            const img = card.querySelector('img');
            if (!img) return;

            const link = card.querySelector('a.photography-link');
            if (!link) return;

            // 图片加载完成后设置 PhotoSwipe 数据属性
            const setPhotoSwipeData = () => {
                if (img.naturalWidth && img.naturalHeight) {
                    link.setAttribute('data-pswp-width', img.naturalWidth.toString());
                    link.setAttribute('data-pswp-height', img.naturalHeight.toString());
                }
            };

            img.addEventListener('load', setPhotoSwipeData);

            // 如果图片已经加载完成（缓存）
            if (img.complete && img.naturalWidth && img.naturalHeight) {
                setPhotoSwipeData();
            }
        });
    });
</script>
