---

import fs from "node:fs/promises";
import path from "node:path";
import { Image, getImage } from "astro:assets";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import 'photoswipe/dist/photoswipe.css';

// Read the photography.txt file during build time
let imageUrls: string[] = [];

try {
	const filePath = path.join(process.cwd(), "public", "photography.txt");
	const content = await fs.readFile(filePath, "utf-8");

	// Parse the file, each line is an image URL
	imageUrls = content
		.split("\n")
		.map((line) => line.trim())
		.filter((line) => line.length > 0 && line.startsWith("http"));
} catch (error) {
	console.error("Error reading photography.txt:", error);
}

const imageData = await Promise.all(
	imageUrls.map(async (url) => {
		try {
			const optimized = await getImage({ src: url, inferSize: true });
			return {
				url,
				width: optimized.attributes.width as number,
				height: optimized.attributes.height as number,
			};
		} catch (e) {
			console.error(`Failed to get size for ${url}`, e);
			return { url, width: 800, height: 600 }; // Fallback
		}
	}),
);
---
<MainGridLayout title="摄影" description="我的摄影作品集，记录生活中的点滴时刻。">
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
        <div class="card-base z-10 px-9 py-6 relative w-full ">
            <h1 class="text-2xl font-bold mb-6">我的摄影作品</h1>
            
            {imageData.length > 0 ? (
                <div id="photography-gallery" class="grid grid-cols-1 md:grid-cols-2 gap-4" style="grid-auto-rows: 10px;">
                    {imageData.map((img, index) => (
                        <div 
                            class="photography-card relative overflow-hidden bg-gray-200 dark:bg-gray-800 shadow-sm hover:shadow-md"
                            style={`grid-row: span ${Math.max(10, Math.ceil((img.height / img.width) * 20))};`}
                        >
                            <a 
                                href={img.url} 
                                class="block w-full h-full cursor-zoom-in photography-link"
                                data-pswp-width={img.width}
                                data-pswp-height={img.height}
                                target="_blank"
                            >
                                <Image 
                                    src={img.url} 
                                    width={img.width}
                                    height={img.height}
                                    alt={`摄影作品 ${index + 1}`} 
                                    class="w-full h-full object-cover hover:scale-105 photography-image"
                                    loading="lazy"
                                    decoding="async"
                                />
                            </a>
                        </div>
                    ))}
                </div>
            ) : (
                <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                    <p>暂无摄影作品</p>
                    <p class="text-sm mt-2">请在 public/photography.txt 文件中添加图片链接</p>
                </div>
            )}
        </div>
    </div>
</MainGridLayout>

<style>
    .photography-image {
        opacity: 1;
    }
</style>

<script>
    // No animation initialization needed
</script>