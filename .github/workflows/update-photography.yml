name: Update Photography

on:
  # 定时运行：每天UTC时间2:00（北京时间10:00）
  schedule:
    - cron: '0 2 * * *'
  # 手动触发
  workflow_dispatch:
  # 每小时运行一次（可选）
  # schedule:
  #   - cron: '0 * * * *'

# Allow this job to clone, modify, and push to repo
permissions:
  contents: write
  id-token: write

jobs:
  update-photography:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get current photography.txt
        id: current-photos
        run: |
          if [ -f "public/photography.txt" ]; then
            CURRENT="$(cat "public/photography.txt")"
            {
              echo "current<<__EOF__"
              echo "$CURRENT"
              echo "__EOF__"
            } >> "$GITHUB_OUTPUT"
          else
            echo "current=" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Fetch photography album from imgchr
        id: fetch-photos
        run: |
          set -e
          echo "Fetching photography album from imgchr..."
          
          # 获取图床相册页面，添加超时和错误处理
          RESPONSE=$(curl -s --max-time 30 --fail-with-body "https://imgchr.com/album/vkBKs" || echo "")
          
          if [ -z "$RESPONSE" ]; then
            echo "Error: Failed to fetch album page"
            exit 1
          fi
          
          # 提取图片链接，使用更安全的正则表达式
          # 只匹配 https:// 开头的完整 URL
          NEW_URLS=$(echo "$RESPONSE" | grep -oP 'https://[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9]*\.[a-zA-Z]{2,}[^"<>\s]*\.(jpg|jpeg|png|webp)' | sort -u)
          
          # 验证 URL 格式
          VALID_URLS=""
          while IFS= read -r url; do
            if [[ "$url" =~ ^https://[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9]*\.[a-zA-Z]{2,} ]]; then
              VALID_URLS="${VALID_URLS}${url}\n"
            fi
          done <<< "$NEW_URLS"
          
          # 转换为每行一个URL的格式，移除末尾空行
          NEW_CONTENT=$(echo -e "$VALID_URLS" | sed '/^$/d')
          
          {
            echo "new<<__EOF__"
            echo -e "$NEW_CONTENT"
            echo "__EOF__"
          } >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Compare and update
        id: compare-update
        run: |
          set -e
          CURRENT="${{ steps.current-photos.outputs.current }}"
          NEW="${{ steps.fetch-photos.outputs.new }}"
          
          # 检查是否成功获取新内容
          if [ -z "$NEW" ]; then
            echo "Error: No new content fetched"
            exit 1
          fi
          
          echo "Current content length: ${#CURRENT}"
          echo "New content length: ${#NEW}"
          
          # 比较是否有变化
          if [ "$CURRENT" != "$NEW" ]; then
            echo "Changes detected, updating photography.txt"
            
            # 备份旧文件
            if [ -f "public/photography.txt" ]; then
              cp "public/photography.txt" "public/photography.txt.backup"
            fi
            
            # 更新文件
            echo -e "$NEW" > "public/photography.txt"
            
            # 设置Git配置
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            
            # 提交更改
            git add "public/photography.txt"
            if [ -f "public/photography.txt.backup" ]; then
              git add "public/photography.txt.backup"
            fi
            
            git commit -m "chore: Update photography.txt from imgchr album [skip ci]" || echo "No changes to commit"
            
            # 推送更改
            git push || echo "Warning: Failed to push changes"
            
            echo "Updated successfully!"
          else
            echo "No changes detected"
          fi
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
